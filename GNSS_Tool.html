<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arrow EOS RTK Point Averaging Tool</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Keep your existing CSS */
        /* ...existing styles here... */
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ Arrow EOS RTK Point Averaging Tool</h1>
        <div class="subtitle">1. Connect Arrow via Bluetooth ‚Üí 2. Enter Point Name ‚Üí 3. Start Collection ‚Üí 4. Export Data</div>
    </div>

    <div id="map"></div>

    <div class="control-panel">
        <!-- Existing control panel markup remains the same -->
        <!-- GPS Source, Device Status, Settings, Buttons, etc. -->
        <div id="resultsContainer" style="display:none;">
            <div class="results-section">
                <h3>‚úÖ Averaged Results</h3>
                <div class="coordinate-display">
                    <strong>Latitude:</strong>
                    <span id="avgLat">--</span>
                </div>
                <div class="coordinate-display">
                    <strong>Longitude:</strong>
                    <span id="avgLon">--</span>
                </div>
                <div class="coordinate-display">
                    <strong>Elevation:</strong>
                    <span id="avgElev">--</span>
                </div>
                <div class="coordinate-display">
                    <strong>Std Deviation:</strong>
                    <span id="stdDev">--</span>
                </div>
                <div class="coordinate-display">
                    <strong>Samples:</strong>
                    <span id="numSamples">--</span>
                </div>
            </div>

            <div class="export-options">
                <button class="btn-export" onclick="exportCSV()">üìÑ CSV</button>
                <button class="btn-export" onclick="exportGeoJSON()">üó∫Ô∏è GeoJSON</button>
                <button class="btn-export" onclick="exportKML()">üåç KML</button>
                <button class="btn-export" onclick="exportGPX()">üìç GPX</button>
                <button class="btn-export" onclick="copyCoordinates()">üìã Copy</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global variables
        let map, currentMarker, averagedMarker;
        let isCollecting = false;
        let watchId = null;
        let readings = [];
        let targetPoints = 50;
        let averagedPoint = null;
        let allCollectedPoints = [];

        // Conversion from ellipsoidal meters to NAVD88 feet
        function convertElevationToFeet(meters) {
            return (meters + 2.035) * 3.28084;
        }

        // Initialize map
        function initMap() {
            map = L.map('map').setView([37.7749, -122.4194], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
        }

        function startCollection() {
            const pointName = document.getElementById('pointName').value.trim();
            if (!pointName) { alert('Enter point name'); return; }

            targetPoints = parseInt(document.getElementById('numPoints').value) || 50;
            readings = [];
            isCollecting = true;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'block';
            document.getElementById('resultsContainer').style.display = 'none';

            watchId = navigator.geolocation.watchPosition(handlePosition, handleError, { enableHighAccuracy: true, maximumAge:0 });
        }

        function stopCollection() {
            if (watchId !== null) navigator.geolocation.clearWatch(watchId);
            isCollecting = false;
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';

            if (readings.length > 0) calculateAverage();
            else alert('No readings collected');
        }

        function handlePosition(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const alt = position.coords.altitude || 0; // meters
            const elevFeet = convertElevationToFeet(alt);

            readings.push({
                lat: lat,
                lon: lon,
                alt: alt,      // original meters (keep for calculation if needed)
                altFeet: elevFeet,
                accuracy: position.coords.accuracy,
                timestamp: new Date()
            });

            document.getElementById('pointCount').textContent = `${readings.length} / ${targetPoints}`;
            showCurrentPoint(lat, lon);

            if (readings.length >= targetPoints) stopCollection();
        }

        function calculateAverage() {
            if (readings.length === 0) return;

            const sumLat = readings.reduce((sum, r) => sum + r.lat, 0);
            const sumLon = readings.reduce((sum, r) => sum + r.lon, 0);
            const sumAltFeet = readings.reduce((sum, r) => sum + r.altFeet, 0);

            const avgLat = sumLat / readings.length;
            const avgLon = sumLon / readings.length;
            const avgElevFeet = sumAltFeet / readings.length;

            const variance = readings.reduce((sum, r) => {
                const dLat = r.lat - avgLat;
                const dLon = r.lon - avgLon;
                const dAlt = r.altFeet - avgElevFeet;
                return sum + (dLat*dLat + dLon*dLon + dAlt*dAlt);
            }, 0) / readings.length;

            const stdDev = Math.sqrt(variance) * 111000; // approximate meters

            averagedPoint = {
                lat: avgLat,
                lon: avgLon,
                altFeet: avgElevFeet,
                stdDev: stdDev,
                numReadings: readings.length,
                readings: [...readings]
            };

            document.getElementById('avgLat').textContent = avgLat.toFixed(8) + '¬∞';
            document.getElementById('avgLon').textContent = avgLon.toFixed(8) + '¬∞';
            document.getElementById('avgElev').textContent = avgElevFeet.toFixed(2) + ' ft';
            document.getElementById('stdDev').textContent = stdDev.toFixed(4) + ' m';
            document.getElementById('numSamples').textContent = readings.length;
            document.getElementById('resultsContainer').style.display = 'block';

            displayAveragedPoint(avgLat, avgLon);
        }

        function displayAveragedPoint(lat, lon) {
            if (averagedMarker) map.removeLayer(averagedMarker);

            averagedMarker = L.marker([lat, lon]).addTo(map);
            averagedMarker.bindPopup(`
                Lat: ${lat.toFixed(8)}¬∞<br>
                Lon: ${lon.toFixed(8)}¬∞<br>
                Elev: ${averagedPoint.altFeet.toFixed(2)} ft<br>
                Samples: ${averagedPoint.numReadings}
            `);
            map.setView([lat, lon], 20);
        }

        // Export CSV, GeoJSON, KML, GPX now use altFeet instead of meters
        function exportCSV() {
            if (!averagedPoint) return;

            let csv = 'Point Name,Latitude,Longitude,Elevation (ft),Std Deviation (m),Num Readings,Date/Time\n';
            readings.forEach((r, i) => {
                csv += `${i+1},${r.lat},${r.lon},${r.altFeet.toFixed(2)},${r.accuracy},${readings.length},${r.timestamp.toISOString()}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `RTK_Points.csv`;
            link.click();
        }

        window.onload = function() {
            initMap();
            const now = new Date();
            document.getElementById('pointName').value = `PT-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
        };
    </script>
</body>
</html>
