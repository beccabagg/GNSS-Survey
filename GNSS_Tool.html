<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arrow EOS RTK Point Averaging Tool</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .header .subtitle {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 2px;
        }

        .control-panel {
            position: absolute;
            top: 90px;
            right: 15px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            width: 340px;
            max-height: calc(100vh - 110px);
            overflow-y: auto;
            z-index: 1000;
        }

        .gps-source-indicator {
            background: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 2px solid #e2e8f0;
        }

        .gps-source-indicator.verified {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .gps-source-indicator.warning {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .gps-source-indicator.error {
            border-color: #dc2626;
            background: #fef2f2;
        }

        .device-status {
            background: #f0f9ff;
            border-left: 4px solid #3b82f6;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .device-status.success {
            background: #d1fae5;
            border-left-color: #10b981;
        }

        .device-status.warning {
            background: #fef3c7;
            border-left-color: #f59e0b;
        }

        .device-status.error {
            background: #fee2e2;
            border-left-color: #dc2626;
        }

        .device-status h3 {
            font-size: 14px;
            color: #1e3a8a;
            margin-bottom: 8px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            font-size: 13px;
        }

        .status-label {
            font-weight: 600;
            color: #64748b;
        }

        .status-value {
            color: #1e3a8a;
            font-weight: 600;
        }

        .settings-section {
            background: #fafafa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .settings-section h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #334155;
        }

        .setting-row {
            margin: 12px 0;
        }

        .setting-row label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #475569;
        }

        .setting-row input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }

        .progress-bar {
            width: 100%;
            height: 28px;
            background: #e2e8f0;
            border-radius: 14px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 13px;
            font-weight: 700;
        }

        button {
            width: 100%;
            padding: 14px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-start {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-stop {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-export {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            font-size: 13px;
            padding: 10px;
        }

        .results-section {
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-radius: 8px;
            border: 2px solid #10b981;
        }

        .results-section h3 {
            font-size: 16px;
            color: #065f46;
            margin-bottom: 12px;
            text-align: center;
        }

        .coordinate-display {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
        }

        .alert {
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 13px;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .export-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .accuracy-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 8px;
        }

        .accuracy-excellent {
            background: #d1fae5;
            color: #065f46;
        }

        .accuracy-good {
            background: #fef3c7;
            color: #92400e;
        }

        .accuracy-poor {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ Arrow EOS RTK Point Averaging Tool</h1>
        <div class="subtitle">1. Connect Arrow via Bluetooth ‚Üí 2. Enter Point Name ‚Üí 3. Start Collection ‚Üí 4. Export Data</div>
    </div>

    <div id="map"></div>

    <div class="control-panel">
        <div class="gps-source-indicator" id="sourceIndicator">
            <div style="font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 8px;">
                üì° GPS SOURCE VERIFICATION
            </div>
            <div id="sourceStatus" style="font-size: 13px;">
                <span id="sourceText">Initializing GPS...</span>
            </div>
            <div id="sourceAdvice" style="margin-top: 8px; font-size: 11px; color: #64748b; font-style: italic;">
                Click "Allow" when browser asks for location permission
            </div>
        </div>

        <div class="device-status" id="deviceStatus">
            <h3>üìä Collection Status</h3>
            <div class="status-row">
                <span class="status-label">GPS Status:</span>
                <span class="status-value" id="gpsStatus">Waiting...</span>
            </div>
            <div class="status-row">
                <span class="status-label">Accuracy:</span>
                <span class="status-value" id="accuracyDisplay">-- m</span>
            </div>
            <div class="status-row">
                <span class="status-label">Points Collected:</span>
                <span class="status-value" id="pointCount">0 / 50</span>
            </div>
        </div>

        <div class="settings-section">
            <h3>‚öôÔ∏è Collection Settings</h3>
            <div class="setting-row">
                <label for="numPoints">Number of Points to Average:</label>
                <input type="number" id="numPoints" value="50" min="10" max="200" step="10">
                <div style="font-size: 11px; color: #64748b; margin-top: 4px; font-style: italic;">
                    üí° Tool collects multiple GPS readings and calculates the mathematical average for higher accuracy
                </div>
            </div>
            <div class="setting-row">
                <label for="pointName">Point Name/ID:</label>
                <input type="text" id="pointName" placeholder="e.g., CP-001" value="">
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill">0%</div>
        </div>

        <button class="btn-start" id="startBtn" onclick="startCollection()">
            üöÄ START COLLECTION
        </button>
        <button class="btn-stop" id="stopBtn" onclick="stopCollection()" style="display:none;">
            ‚è∏Ô∏è STOP COLLECTION
        </button>

        <div id="alertContainer"></div>

        <div id="resultsContainer" style="display:none;">
            <div class="results-section">
                <h3>‚úÖ Averaged Results</h3>
                <div style="font-size: 11px; color: #065f46; margin-bottom: 10px; font-style: italic;">
                    Final coordinates calculated from averaging all collected readings
                </div>
                <div class="coordinate-display">
                    <strong>Latitude:</strong>
                    <span id="avgLat">--</span>
                </div>
                <div class="coordinate-display">
                    <strong>Longitude:</strong>
                    <span id="avgLon">--</span>
                </div>
                <div class="coordinate-display">
                    <strong>Elevation:</strong>
                    <span id="avgElev">--</span>
                </div>
                <div class="coordinate-display">
                    <strong>Std Deviation:</strong>
                    <span id="stdDev">--</span>
                </div>
                <div class="coordinate-display">
                    <strong>Samples:</strong>
                    <span id="numSamples">--</span>
                </div>
            </div>

            <div class="export-options">
                <button class="btn-export" onclick="exportCSV()">üìÑ CSV</button>
                <button class="btn-export" onclick="exportGeoJSON()">üó∫Ô∏è GeoJSON</button>
                <button class="btn-export" onclick="exportKML()">üåç KML</button>
                <button class="btn-export" onclick="exportGPX()">üìç GPX</button>
                <button class="btn-export" onclick="copyCoordinates()">üìã Copy</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global variables
        let map, currentMarker, averagedMarker;
        let isCollecting = false;
        let watchId = null;
        let monitoringWatchId = null;
        let readings = [];
        let targetPoints = 50;
        let averagedPoint = null;
        let allCollectedPoints = [];

        // Initialize map
        function initMap() {
            try {
                map = L.map('map').setView([37.7749, -122.4194], 13);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);

                console.log('Map initialized successfully');
            } catch (error) {
                console.error('Map initialization error:', error);
                showAlert('Error loading map. Check internet connection.', 'error');
            }
        }

        // Start GPS monitoring
        function startGPSMonitoring() {
            console.log('Starting GPS monitoring...');
            
            if (!navigator.geolocation) {
                document.getElementById('sourceText').innerHTML = '<span style="color: #dc2626;">‚ùå Geolocation not supported</span>';
                document.getElementById('sourceAdvice').innerHTML = 'Your browser does not support geolocation';
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
            };

            monitoringWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    console.log('GPS position received:', position.coords.accuracy);
                    updateGPSSourceVerification(position.coords.accuracy);
                    
                    if (!isCollecting) {
                        const accuracy = position.coords.accuracy;
                        let accuracyClass = 'accuracy-poor';
                        let accuracyLabel = 'Poor';
                        if (accuracy < 0.1) {
                            accuracyClass = 'accuracy-excellent';
                            accuracyLabel = 'RTK Fixed';
                        } else if (accuracy < 1) {
                            accuracyClass = 'accuracy-good';
                            accuracyLabel = 'RTK Float';
                        }
                        
                        document.getElementById('accuracyDisplay').innerHTML = 
                            `${accuracy.toFixed(3)} m <span class="accuracy-badge ${accuracyClass}">${accuracyLabel}</span>`;
                        document.getElementById('gpsStatus').textContent = 'Ready';
                    }
                },
                (error) => {
                    console.error('GPS error:', error.code, error.message);
                    let errorMsg = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = '‚ùå Location permission denied. Check browser settings.';
                            document.getElementById('sourceText').innerHTML = '<span style="color: #dc2626;">‚ùå Permission Denied</span>';
                            document.getElementById('sourceAdvice').innerHTML = 'Go to browser Settings ‚Üí Allow location access';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = '‚ö†Ô∏è Location unavailable. Check Arrow connection.';
                            document.getElementById('sourceText').innerHTML = '<span style="color: #d97706;">‚ö†Ô∏è No GPS Signal</span>';
                            break;
                        case error.TIMEOUT:
                            errorMsg = '‚è±Ô∏è GPS timeout. Retrying...';
                            document.getElementById('sourceText').innerHTML = '<span style="color: #d97706;">‚è±Ô∏è GPS Timeout</span>';
                            break;
                    }
                    document.getElementById('gpsStatus').textContent = 'Error';
                },
                options
            );
        }

        // Update GPS source verification
        function updateGPSSourceVerification(accuracy) {
            const indicator = document.getElementById('sourceIndicator');
            const statusDiv = document.getElementById('sourceStatus');
            const adviceDiv = document.getElementById('sourceAdvice');
            const deviceStatus = document.getElementById('deviceStatus');

            let icon, text, advice, className, statusClass;

            if (accuracy < 0.1) {
                icon = '‚úÖ';
                text = '<strong style="color: #059669;">Arrow 200 RTK VERIFIED</strong><br>RTK Fixed - Centimeter accuracy';
                advice = '‚úì Confirmed using Arrow 200 with RTK corrections';
                className = 'verified';
                statusClass = 'success';
            } else if (accuracy >= 0.1 && accuracy < 1) {
                icon = '‚ö†Ô∏è';
                text = '<strong style="color: #d97706;">Likely Arrow 200 (RTK Float)</strong><br>Sub-meter accuracy';
                advice = '‚ö† Arrow connected but RTK Float mode. Wait for Fixed or collect anyway.';
                className = 'warning';
                statusClass = 'warning';
            } else if (accuracy >= 1 && accuracy < 5) {
                icon = '‚ùì';
                text = '<strong style="color: #d97706;">GPS Source Unclear</strong><br>1-5m accuracy';
                advice = '‚ùì Could be Arrow without RTK or phone GPS. Check Arrow app.';
                className = 'warning';
                statusClass = 'warning';
            } else {
                icon = '‚ùå';
                text = '<strong style="color: #dc2626;">Phone GPS Detected</strong><br>Standard GPS (5-10m)';
                advice = '‚ùå NOT using Arrow 200! Check Bluetooth connection.';
                className = 'error';
                statusClass = 'error';
            }

            statusDiv.innerHTML = `<span style="font-size: 20px; margin-right: 10px;">${icon}</span><span>${text}</span>`;
            adviceDiv.innerHTML = advice;
            indicator.className = 'gps-source-indicator ' + className;
            deviceStatus.className = 'device-status ' + statusClass;
        }

        // Start collection
        function startCollection() {
            if (!navigator.geolocation) {
                showAlert('Geolocation is not supported by your browser', 'error');
                return;
            }

            const pointName = document.getElementById('pointName').value.trim();
            if (!pointName) {
                showAlert('Please enter a Point Name/ID before starting', 'warning');
                return;
            }

            targetPoints = parseInt(document.getElementById('numPoints').value) || 50;
            readings = [];
            isCollecting = true;

            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'block';
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('gpsStatus').textContent = 'Collecting...';
            document.getElementById('pointCount').textContent = `0 / ${targetPoints}`;

            clearAlerts();

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            watchId = navigator.geolocation.watchPosition(
                handlePosition,
                handleError,
                options
            );

            showAlert('Collecting GPS readings. Tool will average all readings for final coordinates. Keep device steady.', 'info');
        }

        // Stop collection
        function stopCollection() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }

            isCollecting = false;
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('gpsStatus').textContent = 'Stopped';

            if (readings.length > 0) {
                calculateAverage();
            } else {
                showAlert('No readings collected', 'warning');
            }
        }

        // Handle GPS position
        function handlePosition(position) {
            if (!isCollecting) {
                updateGPSSourceVerification(position.coords.accuracy);
                return;
            }

            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const alt = position.coords.altitude || 0;
            const accuracy = position.coords.accuracy;

            updateGPSSourceVerification(accuracy);

            readings.push({
                lat: lat,
                lon: lon,
                alt: alt,
                accuracy: accuracy,
                timestamp: new Date()
            });

            const count = readings.length;
            const progress = (count / targetPoints) * 100;

            document.getElementById('pointCount').textContent = `${count} / ${targetPoints}`;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressFill').textContent = Math.round(progress) + '%';

            let accuracyClass = 'accuracy-poor';
            let accuracyLabel = 'Poor';
            if (accuracy < 0.1) {
                accuracyClass = 'accuracy-excellent';
                accuracyLabel = 'RTK Fixed';
            } else if (accuracy < 1) {
                accuracyClass = 'accuracy-good';
                accuracyLabel = 'RTK Float';
            }

            document.getElementById('accuracyDisplay').innerHTML = 
                `${accuracy.toFixed(3)} m <span class="accuracy-badge ${accuracyClass}">${accuracyLabel}</span>`;

            showCurrentPoint(lat, lon);

            if (count >= targetPoints) {
                stopCollection();
            }
        }

        // Handle GPS error
        function handleError(error) {
            let errorMsg = 'GPS Error: ';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg += 'Location permission denied.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg += 'Location unavailable. Check Arrow connection.';
                    break;
                case error.TIMEOUT:
                    errorMsg += 'GPS timeout.';
                    break;
                default:
                    errorMsg += error.message;
            }
            showAlert(errorMsg, 'error');
            document.getElementById('gpsStatus').textContent = 'Error';
        }

        // Show current point on map
        function showCurrentPoint(lat, lon) {
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }

            currentMarker = L.circleMarker([lat, lon], {
                radius: 8,
                fillColor: '#fbbf24',
                color: '#f59e0b',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.6
            }).addTo(map);

            if (readings.length === 1) {
                map.setView([lat, lon], 20);
            }
        }

        // Calculate average
        function calculateAverage() {
            if (readings.length === 0) return;

            const sumLat = readings.reduce((sum, r) => sum + r.lat, 0);
            const sumLon = readings.reduce((sum, r) => sum + r.lon, 0);
            const sumAlt = readings.reduce((sum, r) => sum + r.alt, 0);

            const avgLat = sumLat / readings.length;
            const avgLon = sumLon / readings.length;
            const avgAlt = sumAlt / readings.length;

            const variance = readings.reduce((sum, r) => {
                const dLat = r.lat - avgLat;
                const dLon = r.lon - avgLon;
                const dAlt = r.alt - avgAlt;
                return sum + (dLat * dLat + dLon * dLon + dAlt * dAlt);
            }, 0) / readings.length;

            const stdDev = Math.sqrt(variance) * 111000;

            const pointName = document.getElementById('pointName').value.trim();

            averagedPoint = {
                name: pointName,
                lat: avgLat,
                lon: avgLon,
                alt: avgAlt,
                stdDev: stdDev,
                numReadings: readings.length,
                timestamp: new Date(),
                readings: [...readings]
            };

            allCollectedPoints.push(averagedPoint);

            document.getElementById('avgLat').textContent = avgLat.toFixed(8) + '¬∞';
            document.getElementById('avgLon').textContent = avgLon.toFixed(8) + '¬∞';
            document.getElementById('avgElev').textContent = avgAlt.toFixed(3) + ' m';
            document.getElementById('stdDev').textContent = stdDev.toFixed(4) + ' m';
            document.getElementById('numSamples').textContent = readings.length;
            document.getElementById('resultsContainer').style.display = 'block';

            displayAveragedPoint(avgLat, avgLon, pointName);

            if (stdDev < 0.01) {
                showAlert(`Excellent! Collection complete. Std dev: ${stdDev.toFixed(4)}m`, 'success');
            } else if (stdDev < 0.1) {
                showAlert(`Good collection with ${readings.length} points.`, 'success');
            } else {
                showAlert(`Collection complete but std dev is high (${stdDev.toFixed(4)}m).`, 'warning');
            }
        }

        // Display averaged point on map
        function displayAveragedPoint(lat, lon, name) {
            if (averagedMarker) {
                map.removeLayer(averagedMarker);
            }

            averagedMarker = L.marker([lat, lon], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: #10b981; color: white; padding: 8px 12px; border-radius: 20px; font-weight: bold; font-size: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); white-space: nowrap;">${name}</div>`,
                    iconSize: null
                })
            }).addTo(map);

            averagedMarker.bindPopup(`
                <b>${name}</b><br>
                Lat: ${lat.toFixed(8)}¬∞<br>
                Lon: ${lon.toFixed(8)}¬∞<br>
                Elev: ${averagedPoint.alt.toFixed(3)} m<br>
                Samples: ${averagedPoint.numReadings}
            `);

            map.setView([lat, lon], 20);
        }

        // Export functions
        function exportCSV() {
            if (!averagedPoint) return;

            let csv = 'Point Name,Latitude,Longitude,Elevation (m),Std Deviation (m),Num Readings,Date/Time\n';
            
            allCollectedPoints.forEach(pt => {
                csv += `"${pt.name}",${pt.lat},${pt.lon},${pt.alt},${pt.stdDev},${pt.numReadings},"${pt.timestamp.toISOString()}"\n`;
            });

            csv += '\n\nIndividual Readings for ' + averagedPoint.name + '\n';
            csv += 'Reading #,Latitude,Longitude,Elevation (m),Accuracy (m),Timestamp\n';
            
            averagedPoint.readings.forEach((r, i) => {
                csv += `${i+1},${r.lat},${r.lon},${r.alt},${r.accuracy},"${r.timestamp.toISOString()}"\n`;
            });

            downloadFile(csv, `${averagedPoint.name}_RTK_Points.csv`, 'text/csv');
            showAlert('CSV file downloaded!', 'success');
        }

        function exportGeoJSON() {
            if (allCollectedPoints.length === 0) {
                showAlert('No points to export', 'warning');
                return;
            }

            const geojson = {
                type: 'FeatureCollection',
                features: allCollectedPoints.map(pt => ({
                    type: 'Feature',
                    properties: {
                        name: pt.name,
                        elevation: parseFloat(pt.alt.toFixed(3)),
                        std_dev: parseFloat(pt.stdDev.toFixed(4)),
                        num_readings: pt.numReadings,
                        timestamp: pt.timestamp.toISOString()
                    },
                    geometry: {
                        type: 'Point',
                        coordinates: [parseFloat(pt.lon.toFixed(8)), parseFloat(pt.lat.toFixed(8)), parseFloat(pt.alt.toFixed(3))]
                    }
                }))
            };

            downloadFile(JSON.stringify(geojson, null, 2), 'RTK_Points.geojson', 'application/geo+json');
            showAlert('GeoJSON file downloaded!', 'success');
        }

        function exportKML() {
            if (allCollectedPoints.length === 0) {
                showAlert('No points to export', 'warning');
                return;
            }

            let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>RTK Points</name>
`;

            allCollectedPoints.forEach(pt => {
                kml += `    <Placemark>
      <name>${pt.name}</name>
      <description>Elev: ${pt.alt.toFixed(3)}m, StdDev: ${pt.stdDev.toFixed(4)}m, Samples: ${pt.numReadings}</description>
      <Point>
        <coordinates>${pt.lon.toFixed(8)},${pt.lat.toFixed(8)},${pt.alt.toFixed(3)}</coordinates>
      </Point>
    </Placemark>
`;
            });

            kml += `  </Document>
</kml>`;

            downloadFile(kml, 'RTK_Points.kml', 'application/vnd.google-earth.kml+xml');
            showAlert('KML file downloaded!', 'success');
        }

        function exportGPX() {
            if (allCollectedPoints.length === 0) {
                showAlert('No points to export', 'warning');
                return;
            }

            let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="Arrow RTK Tool">
  <metadata>
    <name>RTK Points</name>
  </metadata>
`;

            allCollectedPoints.forEach(pt => {
                gpx += `  <wpt lat="${pt.lat.toFixed(8)}" lon="${pt.lon.toFixed(8)}">
    <ele>${pt.alt.toFixed(3)}</ele>
    <name>${pt.name}</name>
    <desc>Elev: ${pt.alt.toFixed(3)}m, StdDev: ${pt.stdDev.toFixed(4)}m, Samples: ${pt.numReadings}</desc>
  </wpt>
`;
            });

            gpx += `</gpx>`;

            downloadFile(gpx, 'RTK_Points.gpx', 'application/gpx+xml');
            showAlert('GPX file downloaded!', 'success');
        }

        function copyCoordinates() {
            if (!averagedPoint) return;

            const text = `${averagedPoint.name}
Latitude: ${averagedPoint.lat.toFixed(8)}¬∞
Longitude: ${averagedPoint.lon.toFixed(8)}¬∞
Elevation: ${averagedPoint.alt.toFixed(3)} m
Std Deviation: ${averagedPoint.stdDev.toFixed(4)} m
Samples: ${averagedPoint.numReadings}`;

            navigator.clipboard.writeText(text).then(() => {
                showAlert('Coordinates copied to clipboard!', 'success');
            }).catch(() => {
                showAlert('Could not copy to clipboard', 'error');
            });
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 6000);
        }

        function clearAlerts() {
            document.getElementById('alertContainer').innerHTML = '';
        }

        // Initialize on load
        window.onload = function() {
            console.log('Page loaded, initializing...');
            
            initMap();
            
            const now = new Date();
            const defaultName = `PT-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
            document.getElementById('pointName').value = defaultName;

            // Start GPS monitoring
            startGPSMonitoring();
        };
    </script>
</body>
</html>
